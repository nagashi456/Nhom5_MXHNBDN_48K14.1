{% extends "base.html" %}
{% load static %}

{% block title %}·ª®ng d·ª•ng Chat{% endblock %}

{% block extra_css %}
<style>
    /* Override base template styles to prevent scrolling */
    body {
        overflow: hidden !important;
    }

    .app-container {
        overflow: hidden !important;
    }

    /* Add to your existing CSS */
.attachment-buttons {
    display: flex;
    margin-right: 8px;
    gap:10px;
}

.attachment-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    color: #6b7280;
    transition: background-color 0.2s;
}

.attachment-btn:hover {
    background-color: #f3f4f6;
    color: #3b82f6;
}

.hidden {
    display: none !important;
}

.attachment-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 8px;
    background-color: #f9fafb;
    border-radius: 4px;
    margin-top: 8px;
}

.attachment-item {
    display: flex;
    align-items: center;
    background-color: white;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #e5e7eb;
    font-size: 12px;
}

.attachment-item svg {
    margin-right: 4px;
}

.attachment-item .remove-btn {
    margin-left: 4px;
    cursor: pointer;
    color: #ef4444;
}

.message-attachment {
    margin-top: 8px;
    padding: 8px;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

.message-attachment a {
    display: flex;
    align-items: center;
    color: inherit;
    text-decoration: underline;
}

.message-attachment svg {
    margin-right: 4px;
}

.message-image {
    margin-top: 8px;
    max-width: 100%;
    border-radius: 4px;
}

.chat-input {
    padding: 16px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    flex-wrap: wrap;
    background-color: white;
    flex-shrink: 0;
}

    .main-content {
        overflow: hidden !important;
        height: 100vh !important;
    }

    .content-area {
        padding: 0 !important;
        overflow: hidden !important;
        height: 100% !important;
        display: flex !important;
        flex-direction: column !important;
    }

    /* Chat container - takes full height */
    .chat-container {
        display: flex;
        height: 100%;
        width: 100%;
        overflow: hidden;
    }
    .sidebar {
        height: !important;
    }
    /* Sidebar */
    .sidebar-chat {
        width: 320px;
        background-color: white;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .create-message-btn {
        margin: 16px;
        padding: 10px;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .create-message-btn:hover {
        background-color: #2563eb;
    }

    .create-message-btn svg {
        margin-right: 8px;
    }

    .rooms-title {
        padding: 8px 16px;
        font-weight: bold;
        font-size: 18px;
        flex-shrink: 0;
    }

    .rooms-list {
        flex: 1;
        overflow-y: auto;
    }

    .room-item {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

    .room-item:hover {
        background-color: #f3f4f6;
    }

    .room-item.active {
        background-color: #f3f4f6;
    }

    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .avatar-text {
        font-weight: bold;
        color: #4b5563;
    }

    .room-info {
        flex: 1;
        min-width: 0;
    }

    .room-name {
        font-weight: 500;
        margin-bottom: 4px;
    }

    .room-last-message {
        font-size: 14px;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .room-time {
        font-size: 12px;
        color: #6b7280;
        white-space: nowrap;
    }

    /* Main chat area */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    #chatRoom.active-chat {
        display: flex;
        flex-direction: column;
        height: 100%;
        margin: 0;
        background: #f0f2f5;
    }

    .chat-header {
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        background-color: white;
        flex-shrink: 0;
    }

    .chat-header-info {
        margin-left: 12px;
    }

    .chat-header-name {
        font-weight: 500;
    }

    .chat-header-participants {
        font-size: 14px;
        color: #6b7280;
    }

    /* This is the key element - it will have its own scrollbar */
    .chat-messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        min-height: 0; /* Important for Firefox */
    }

    .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #6b7280;
    }

    .empty-state svg {
        margin-bottom: 16px;
    }

    .empty-state-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .message {
        margin-bottom: 16px;
        display: flex;
        max-width: 70%;
    }

    .message.sent {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message.received {
        align-self: flex-start;
    }

    .message-content {
        padding: 12px;
        border-radius: 12px;
        margin: 0 8px;
    }

    .message.sent .message-content {
        background-color: #3b82f6;
        color: white;
    }

    .message.received .message-content {
        background-color: #e5e7eb;
    }

    .message-time {
        font-size: 12px;
        margin-top: 4px;
        color: #9ca3af;
    }

    .message.sent .message-time {
        color: #bfdbfe;
        text-align: right;
    }

    .chat-input {
        padding: 16px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        background-color: white;
        flex-shrink: 0;
    }

    .chat-input input {
        flex: 1;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        margin-right: 8px;
    }

    .chat-input button {
        padding: 10px 16px;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .chat-input button:hover {
        background-color: #2563eb;
    }

    .chat-input button:disabled {
        background-color: #93c5fd;
        cursor: not-allowed;
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal {
        background-color: white;
        border-radius: 8px;
        width: 400px;
        max-width: 90%;
    }

    .modal-header {
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 600;
    }

    .modal-close {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
    }

    .modal-body {
        padding: 16px;
    }

    .search-container {
        position: relative;
        margin-bottom: 16px;
    }

    .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
    }

    .search-input {
        width: 100%;
        padding: 10px 10px 10px 36px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
    }

    .users-list {
        max-height: 320px;
        overflow-y: auto;
    }

    .user-item {
        padding: 8px;
        display: flex;
        align-items: center;
        cursor: pointer;
        border-radius: 4px;
    }

    .user-item:hover {
        background-color: #f3f4f6;
    }

    .user-name {
        margin-left: 12px;
    }

    .hidden {
        display: none;
    }

    .loading-indicator {
        text-align: center;
        padding: 16px;
        color: #6b7280;
    }

    .error-message {
        text-align: center;
        padding: 16px;
        color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar-chat">
        <button class="create-message-btn" id="createMessageBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            T·∫°o tin nh·∫Øn
        </button>

        <div class="rooms-title">Ph√≤ng chat</div>

        <div class="rooms-list" id="roomsList">
            <!-- Room items will be added here dynamically -->
        </div>
    </div>

    <!-- Main chat area -->
    <div class="chat-main">
        <div id="emptyState" class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <div class="empty-state-title">Ch·ªçn m·ªôt ph√≤ng chat ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
            <div class="empty-state-description">Ch·ªçn m·ªôt ph√≤ng chat t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán</div>
        </div>

        <div id="chatRoom" class="hidden">
            <div class="chat-header" id="chatHeader">
                <!-- Chat header will be added here dynamically -->
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here dynamically -->
            </div>

            <div class="chat-input">
                <div class="attachment-buttons">
                    <button type="button" id="fileButton" class="attachment-btn" title="Attach file">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                        </svg>
                    </button>
                    <button type="button" id="imageButton" class="attachment-btn" title="Attach image">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </button>
                </div>
                <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
                <button id="sendButton" disabled>G·ª≠i</button>
            </div>
        </div>
    </div>
</div>

<!-- Create message modal -->
<div id="createMessageModal" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">T·∫°o tin nh·∫Øn m·ªõi</div>
            <button class="modal-close" id="closeModalBtn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="search-container">
                <div class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </div>
                <input type="text" class="search-input" id="searchInput" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng...">
            </div>

            <div class="users-list" id="usersList">
                <!-- User items will be added here dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null;
let rooms = [];
let selectedRoom = null;
let messages = [];
let socket = null;
let searchTimeout = null;

// DOM elements
const roomsList = document.getElementById('roomsList');
const emptyState = document.getElementById('emptyState');
const chatRoom = document.getElementById('chatRoom');
const chatHeader = document.getElementById('chatHeader');
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const createMessageBtn = document.getElementById('createMessageBtn');
const createMessageModal = document.getElementById('createMessageModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const searchInput = document.getElementById('searchInput');
const usersList = document.getElementById('usersList');

// L·∫•y CSRF token t·ª´ cookie
function getCsrfToken() {
    const name = 'csrftoken=';
    const decodedCookie = decodeURIComponent(document.cookie);
    const cookieArray = decodedCookie.split(';');

    for (let i = 0; i < cookieArray.length; i++) {
        let cookie = cookieArray[i].trim();
        if (cookie.indexOf(name) === 0) {
            return cookie.substring(name.length, cookie.length);
        }
    }
    return '';
}

/////////////////////////img/////////////////////////
// --- Khai b√°o c√°c bi·∫øn ƒë·ªÉ l∆∞u t·∫°m attachment v√† image tr∆∞·ªõc khi g·ª≠i ---
let pendingAttachment = null;
let pendingImage = null;

// T·∫°o c√°c input[type=file] ·∫©n ƒë·ªÉ ch·ªçn file v√† image
const fileInput = document.createElement('input');
fileInput.type = 'file';
fileInput.classList.add('hidden');
document.body.appendChild(fileInput);

const imageInput = document.createElement('input');
imageInput.type = 'file';
imageInput.accept = 'image/*';
imageInput.classList.add('hidden');
document.body.appendChild(imageInput);

// B·∫Øt s·ª± ki·ªán click v√†o n√∫t attach
fileButton.addEventListener('click', () => fileInput.click());
imageButton.addEventListener('click', () => imageInput.click());

// Khi ng∆∞·ªùi d√πng ch·ªçn 1 file b·∫•t k·ª≥
fileInput.addEventListener('change', async () => {
    const file = fileInput.files[0];
    if (!file) return;
    const form = new FormData();
    form.append('file', file);
    try {
        const res = await fetch('/api/upload/file/', {
            method: 'POST',
            credentials: 'include',
            headers: { 'X-CSRFToken': getCsrfToken() },
            body: form
        });
        const data = await res.json();
        if (res.ok) {
            pendingAttachment = data.id;
            showAttachmentPreview(data.name);
            sendButton.disabled = false;    // ‚Üê b·∫≠t n√∫t g·ª≠i
        } else {
            alert(data.error || 'Upload file th·∫•t b·∫°i');
        }
    } catch (err) {
        console.error(err);
        alert('L·ªói m·∫°ng khi upload file');
    }
    fileInput.value = '';
});


// Khi ch·ªçn h√¨nh ·∫£nh
imageInput.addEventListener('change', async () => {
    const file = imageInput.files[0];
    if (!file) return;
    const form = new FormData();
    form.append('image', file);
    try {
        const res = await fetch('/api/upload/image/', {
            method: 'POST',
            credentials: 'include',
            headers: { 'X-CSRFToken': getCsrfToken() },
            body: form
        });
        const data = await res.json();
        if (res.ok) {
            pendingImage = data.id;
            showImagePreview(data.url);
            sendButton.disabled = false;    // ‚Üê B·∫≠t n√∫t ·ªü ƒë√¢y
        } else {
            alert(data.error || 'Upload image th·∫•t b·∫°i');
        }
    } catch (err) {
        console.error(err);
        alert('L·ªói m·∫°ng khi upload ·∫£nh');
    }
    imageInput.value = '';
});

// H√†m hi·ªÉn th·ªã preview ph√≠a UI
function showAttachmentPreview(filename) {
    let preview = document.querySelector('.attachment-preview');
    if (!preview) {
        preview = document.createElement('div');
        preview.className = 'attachment-preview';
        document.querySelector('.chat-input').prepend(preview);
    }
    preview.innerHTML = `
        <div class="attachment-item">
            üìé ${filename}
            <span class="remove-btn">&times;</span>
        </div>
    `;
    // B·∫Øt s·ª± ki·ªán x√≥a preview
    preview.querySelector('.remove-btn').onclick = () => {
        pendingAttachment = null;
        preview.remove();
    };
}

function showImagePreview(url) {
    let preview = document.querySelector('.attachment-preview');
    if (!preview) {
        preview = document.createElement('div');
        preview.className = 'attachment-preview';
        document.querySelector('.chat-input').prepend(preview);
    }
    preview.innerHTML = `
        <div class="attachment-item">
            <img src="${url}" style="max-height:40px; margin-right:4px;" />
            <span class="remove-btn">&times;</span>
        </div>
    `;
    preview.querySelector('.remove-btn').onclick = () => {
        pendingImage = null;
        preview.remove();
    };
}
//////////////////////////endimg///////////////////////


// L·∫•y th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i
async function getCurrentUser() {
    try {
        const response = await fetch('/api/users/current/');

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi d√πng');
        }

        const data = await response.json();
        currentUser = {
            id: data.id,
            name: data.username
        };

    } catch (error) {
        console.error('L·ªói khi l·∫•y th√¥ng tin ng∆∞·ªùi d√πng:', error);
        // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p n·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin ng∆∞·ªùi d√πng
        window.location.href = '/accounts/login/?next=' + window.location.pathname;
    }
}

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng
async function init() {
    try {
        // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
        roomsList.innerHTML = '<div class="loading-indicator">ƒêang t·∫£i...</div>';

        // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i
        await getCurrentUser();

        // G·ªçi API ƒë·ªÉ l·∫•y danh s√°ch ph√≤ng chat
        const response = await fetch('/api/rooms/');

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ l·∫•y danh s√°ch ph√≤ng chat');
        }

        const data = await response.json();
        rooms = data.rooms;

        // Render danh s√°ch ph√≤ng chat
        renderRooms();

        // Thi·∫øt l·∫≠p c√°c event listeners
        setupEventListeners();

    } catch (error) {
        console.error('L·ªói khi kh·ªüi t·∫°o ·ª©ng d·ª•ng:', error);
        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        roomsList.innerHTML = '<div class="error-message">Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.</div>';
    }
}

// Render danh s√°ch ph√≤ng chat
function renderRooms() {
    roomsList.innerHTML = '';

    if (rooms.length === 0) {
        roomsList.innerHTML = '<div class="text-center py-4 text-gray-500">Kh√¥ng c√≥ ph√≤ng chat n√†o</div>';
        return;
    }

    rooms.forEach(room => {
        const roomElement = document.createElement('div');
        roomElement.className = `room-item ${selectedRoom && selectedRoom.id === room.id ? 'active' : ''}`;
        roomElement.dataset.roomId = room.id;

        let avatarContent;
        if (room.is_private) {
            // T√¨m ng∆∞·ªùi d√πng kh√°c trong ph√≤ng chat ri√™ng t∆∞
            const otherParticipant = room.participants.find(p => p.id !== currentUser.id);
            avatarContent = otherParticipant ? otherParticipant.username.charAt(0) : room.name.charAt(0);
        } else {
            avatarContent = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>';
        }

        roomElement.innerHTML = `
            <div class="avatar">
                ${room.is_private ? `<span class="avatar-text">${avatarContent}</span>` : avatarContent}
            </div>
            <div class="room-info">
                <div class="room-name">${room.name}</div>
                <div class="room-last-message">${room.last_message || ''}</div>
            </div>
            <div class="room-time">${room.last_message_time || ''}</div>
        `;

        roomElement.addEventListener('click', () => selectRoom(room));
        roomsList.appendChild(roomElement);
    });
}

// Thi·∫øt l·∫≠p c√°c event listeners
function setupEventListeners() {
    messageInput.addEventListener('input', () => {
        sendButton.disabled = !messageInput.value.trim();
    });

    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey && messageInput.value.trim()) {
            e.preventDefault();
            sendMessage();
        }
    });

    sendButton.addEventListener('click', sendMessage);

    createMessageBtn.addEventListener('click', () => {
        renderUsers();
        createMessageModal.classList.remove('hidden');
    });

    closeModalBtn.addEventListener('click', () => {
        createMessageModal.classList.add('hidden');
    });

    searchInput.addEventListener('input', () => {
        // S·ª≠ d·ª•ng debounce ƒë·ªÉ tr√°nh g·ªçi API qu√° nhi·ªÅu
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            renderUsers();
        }, 300);
    });
}

// K·∫øt n·ªëi WebSocket
function connectWebSocket(roomId) {
    // ƒê√≥ng k·∫øt n·ªëi c≈© n·∫øu c√≥
    if (socket && socket.close) {
        socket.close();
    }

    // X√°c ƒë·ªãnh protocol (ws ho·∫∑c wss)
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const host = window.location.host;

    // T·∫°o k·∫øt n·ªëi WebSocket m·ªõi
    socket = new WebSocket(`${protocol}//${host}/ws/chat/${roomId}/`);

    // X·ª≠ l√Ω s·ª± ki·ªán khi k·∫øt n·ªëi m·ªü
    socket.onopen = function(e) {
        console.log('WebSocket connection established');
    };

    // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫≠n tin nh·∫Øn
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.type === 'chat_message') {
            // B·ªè qua tin nh·∫Øn n·∫øu n√≥ t·ª´ ng∆∞·ªùi d√πng hi·ªán t·∫°i
            if (data.sender_id === currentUser.id) {
                return;
            }

            // T·∫°o ƒë·ªëi t∆∞·ª£ng tin nh·∫Øn m·ªõi
            const newMessage = {
                id: data.message_id,
                content: data.message,
                sender: {
                    id: data.sender_id,
                    name: data.sender_name
                },
                timestamp: data.timestamp
            };

            // Th√™m tin nh·∫Øn v√†o danh s√°ch
            addMessage(newMessage);

            // C·∫≠p nh·∫≠t tin nh·∫Øn cu·ªëi c√πng c·ªßa ph√≤ng chat
            updateRoomLastMessage(selectedRoom.id, data.message, 'V·ª´a xong');
        }
    };

    // X·ª≠ l√Ω s·ª± ki·ªán khi k·∫øt n·ªëi ƒë√≥ng
    socket.onclose = function(e) {
        console.log('WebSocket connection closed');
    };

    // X·ª≠ l√Ω s·ª± ki·ªán khi c√≥ l·ªói
    socket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };
}

// Ch·ªçn m·ªôt ph√≤ng chat
function selectRoom(room) {
    selectedRoom = room;
    renderRooms(); // C·∫≠p nh·∫≠t tr·∫°ng th√°i active

    // Hi·ªÉn th·ªã ph√≤ng chat, ·∫©n tr·∫°ng th√°i tr·ªëng
    emptyState.classList.add('hidden');
    chatRoom.classList.remove('hidden');
    chatRoom.classList.add('active-chat');
    // Render header ph√≤ng chat
    renderChatHeader();

    // K·∫øt n·ªëi WebSocket cho ph√≤ng chat n√†y
    connectWebSocket(room.id);

    // L·∫•y v√† hi·ªÉn th·ªã tin nh·∫Øn
    fetchMessages(room.id);
}

// Render header ph√≤ng chat
function renderChatHeader() {
    // T√¨m ng∆∞·ªùi d√πng kh√°c trong ph√≤ng chat ri√™ng t∆∞
    const otherParticipant = selectedRoom.is_private
        ? selectedRoom.participants.find(p => p.id !== currentUser.id)
        : null;

    let avatarContent;
    if (selectedRoom.is_private) {
        avatarContent = `<span class="avatar-text">${otherParticipant ? otherParticipant.username.charAt(0) : selectedRoom.name.charAt(0)}</span>`;
    } else {
        avatarContent = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>';
    }

    chatHeader.innerHTML = `
        <div class="avatar">
            ${avatarContent}
        </div>
        <div class="chat-header-info">
            <div class="chat-header-name">${selectedRoom.name}</div>
            <div class="chat-header-participants">
                ${selectedRoom.is_private ? 'Tr√≤ chuy·ªán ri√™ng t∆∞' : `${selectedRoom.participants.length} th√†nh vi√™n`}
            </div>
        </div>
    `;
}

// L·∫•y tin nh·∫Øn cho m·ªôt ph√≤ng chat
async function fetchMessages(roomId) {
    try {
        // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
        chatMessages.innerHTML = '<div class="loading-indicator">ƒêang t·∫£i tin nh·∫Øn...</div>';

        // G·ªçi API ƒë·ªÉ l·∫•y tin nh·∫Øn
        const response = await fetch(`/api/rooms/${roomId}/messages/`);

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ l·∫•y tin nh·∫Øn');
        }

        const data = await response.json();
        messages = data.messages;

        // Render tin nh·∫Øn
        renderMessages();

    } catch (error) {
        console.error('L·ªói khi l·∫•y tin nh·∫Øn:', error);
        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói trong khu v·ª±c chat
        chatMessages.innerHTML = '<div class="error-message">Kh√¥ng th·ªÉ t·∫£i tin nh·∫Øn. Vui l√≤ng th·ª≠ l·∫°i.</div>';
    }
}

// Render tin nh·∫Øn
function renderMessages() {
    chatMessages.innerHTML = '';

    if (messages.length === 0) {
        chatMessages.innerHTML = '<div class="text-center py-4 text-gray-500">Ch∆∞a c√≥ tin nh·∫Øn n√†o</div>';
        return;
    }

    messages.forEach(message => {
        const messageElement = createMessageElement(message);
        chatMessages.appendChild(messageElement);
    });

    // Cu·ªôn xu·ªëng d∆∞·ªõi c√πng
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// T·∫°o ph·∫ßn t·ª≠ tin nh·∫Øn
function createMessageElement(message) {
    const isSent = message.sender.id === currentUser.id;
    const messageElement = document.createElement('div');
    messageElement.className = `message ${isSent ? 'sent' : 'received'}`;

    const formattedTime = formatTime(message.timestamp);

    if (!isSent) {
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerHTML = `<span class="avatar-text">${message.sender.username ? message.sender.username.charAt(0) : message.sender.name.charAt(0)}</span>`;
        messageElement.appendChild(avatar);
    }

    const contentElement = document.createElement('div');
    contentElement.className = 'message-content';
    contentElement.textContent = message.content;
    contentElement.innerHTML += `<div class="message-time">${formattedTime}</div>`;
    messageElement.appendChild(contentElement);

    return messageElement;
}

// Th√™m tin nh·∫Øn m·ªõi
function addMessage(message) {

    if (messages.length === 0) {
        chatMessages.innerHTML = '';
    }

    messages.push(message);
    const messageElement = createMessageElement(message);
    chatMessages.appendChild(messageElement);

    // Cu·ªôn xu·ªëng d∆∞·ªõi c√πng
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// G·ª≠i tin nh·∫Øn
// --- ƒêi·ªÅu ch·ªânh h√†m sendMessage ƒë·ªÉ k√®m attachment_id & image_id ---
// G·ª≠i tin nh·∫Øn
function sendMessage() {
    if (!messageInput.value.trim() || !selectedRoom || !socket || socket.readyState !== WebSocket.OPEN) return;

    // T·∫°o ƒë·ªëi t∆∞·ª£ng tin nh·∫Øn m·ªõi cho giao di·ªán
    const newMessage = {
        id: 'temp-' + Math.random().toString(),
        content: messageInput.value.trim(),
        sender: currentUser,
        timestamp: new Date().toISOString()
    };

    // Th√™m tin nh·∫Øn v√†o giao di·ªán
    addMessage(newMessage);

    // G·ª≠i tin nh·∫Øn qua WebSocket
    const messageData = {
        type: 'chat_message',
        message: messageInput.value.trim()
    };

    socket.send(JSON.stringify(messageData));

    // C·∫≠p nh·∫≠t tin nh·∫Øn cu·ªëi c√πng c·ªßa ph√≤ng chat
    updateRoomLastMessage(selectedRoom.id, newMessage.content, 'V·ª´a xong');

    // X√≥a n·ªôi dung input
    messageInput.value = '';
    sendButton.disabled = true;
}



// C·∫≠p nh·∫≠t tin nh·∫Øn cu·ªëi c√πng c·ªßa ph√≤ng chat
function updateRoomLastMessage(roomId, message, time) {
    const roomIndex = rooms.findIndex(r => r.id === roomId);
    if (roomIndex !== -1) {
        rooms[roomIndex].last_message = message;
        rooms[roomIndex].last_message_time = time;
        renderRooms();
    }
}

//
async function renderUsers() {
    const query = searchInput.value.trim();

    try {
        usersList.innerHTML = '<div class="loading-indicator">ƒêang t√¨m ki·∫øm...</div>';

        // G·ªçi API t√¨m ki·∫øm ng∆∞·ªùi d√πng
        const response = await fetch(`/api/users/search/?q=${encodeURIComponent(query)}`);

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ t√¨m ki·∫øm ng∆∞·ªùi d√πng');
        }

        const data = await response.json();
        const filteredUsers = data.users;

        usersList.innerHTML = '';

        if (filteredUsers.length === 0) {
            usersList.innerHTML = '<div class="text-center py-4 text-gray-500">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng</div>';
            return;
        }

        filteredUsers.forEach(user => {
            const userElement = document.createElement('div');
            userElement.className = 'user-item';
            userElement.innerHTML = `
                <div class="avatar">
                    <span class="avatar-text">${user.username.charAt(0)}</span>
                </div>
                <div class="user-name">${user.username}</div>
            `;

            userElement.addEventListener('click', () => createPrivateRoom(user));
            usersList.appendChild(userElement);
        });

    } catch (error) {
        console.error('L·ªói khi t√¨m ki·∫øm ng∆∞·ªùi d√πng:', error);
        usersList.innerHTML = '<div class="error-message">Kh√¥ng th·ªÉ t√¨m ki·∫øm. Vui l√≤ng th·ª≠ l·∫°i.</div>';
    }
}

// T·∫°o ph√≤ng chat ri√™ng t∆∞ v·ªõi m·ªôt ng∆∞·ªùi d√πng
async function createPrivateRoom(user) {
    try {
        // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
        usersList.innerHTML = '<div class="loading-indicator">ƒêang t·∫°o ph√≤ng chat...</div>';

        // G·ªçi API ƒë·ªÉ t·∫°o ph√≤ng chat ri√™ng t∆∞
        const response = await fetch('/api/rooms/create_private/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({ user_id: user.id }),
        });

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ t·∫°o ph√≤ng chat ri√™ng t∆∞');
        }

        const data = await response.json();

        // C·∫≠p nh·∫≠t danh s√°ch ph√≤ng chat
        await refreshRooms();

        // T√¨m ph√≤ng chat v·ª´a t·∫°o
        const newRoom = rooms.find(room => room.id === data.room_id);

        if (newRoom) {
            // Ch·ªçn ph√≤ng chat m·ªõi
            selectRoom(newRoom);
        }

        // ƒê√≥ng modal
        createMessageModal.classList.add('hidden');

    } catch (error) {
        console.error('L·ªói khi t·∫°o ph√≤ng chat ri√™ng t∆∞:', error);
        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        usersList.innerHTML = '<div class="error-message">Kh√¥ng th·ªÉ t·∫°o ph√≤ng chat. Vui l√≤ng th·ª≠ l·∫°i.</div>';

        // T·ª± ƒë·ªông ƒë√≥ng th√¥ng b√°o l·ªói sau 3 gi√¢y
        setTimeout(() => {
            renderUsers();
        }, 3000);
    }
}

// L√†m m·ªõi danh s√°ch ph√≤ng chat
async function refreshRooms() {
    try {
        const response = await fetch('/api/rooms/');

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ l·∫•y danh s√°ch ph√≤ng chat');
        }

        const data = await response.json();
        rooms = data.rooms;
        renderRooms();

    } catch (error) {
        console.error('L·ªói khi l√†m m·ªõi danh s√°ch ph√≤ng chat:', error);
    }
}

// Format timestamp th√†nh th·ªùi gian c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c
function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng khi trang t·∫£i xong
document.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}

{% block body_class %}no-scroll{% endblock %}